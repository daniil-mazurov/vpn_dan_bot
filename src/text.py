import os
import uuid
from dataclasses import dataclass

import aiofiles
import pyqrcode
from pytils.numeral import get_plural

from core.config import settings
from core.path import PATH
from db.models import UserActivity, UserData, WgConfig

me = {"—è", "–º–æ–∏ –¥–∞–Ω–Ω—ã–µ", "–¥–∞–Ω–Ω—ã–µ", "–∫–æ–Ω—Ñ–∏–≥–∏", "–º–æ–∏ –∫–æ–Ω—Ñ–∏–≥–∏", "config", "–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"}
yes = {"yes", "y", "da", "–¥–∞"}
no = {"no", "n", "–Ω–µ—Ç"}

only_admin = "–î–∞–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ï—Å–ª–∏ –≤—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –∞ –º—ã –Ω–µ –∑–Ω–∞–µ–º –æ–± —ç—Ç–æ–º, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å."

DB_ERROR = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
WG_ERROR = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É wireguard. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
YOO_ERROR = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É yoomoney. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –ø–æ–∑–∂–µ"
UNPAY = "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –î–µ–π—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É."

rates = {0.3: "–ü—Ä–æ–±–Ω—ã–π", 1: "–ë–∞–∑–æ–≤—ã–π", 2.5: "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π", 5: "–õ—é–∫—Å"}


@dataclass
class AccountStatuses:
    freezed = "–ó–∞–º–æ—Ä–æ–∂–µ–Ω"
    admin = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
    user = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π"
    deleted = "–£–¥–∞–ª–µ–Ω"
    banned = "–ó–∞–±–∞–Ω–µ–Ω"


def get_account_status(user_data: UserData):
    if user_data.active == UserActivity.freezed:
        return AccountStatuses.freezed
    elif user_data.admin:
        return AccountStatuses.admin
    else:
        return AccountStatuses.user


def get_sub_status(user_data: UserData):
    if user_data.active == UserActivity.active:
        return f"–ê–∫—Ç–∏–≤–Ω–∞ | {rates.get(user_data.stage,'–ù–µ–æ–ø–æ–∑–Ω–∞–Ω–Ω—ã–π')} –¢–∞—Ä–∏—Ñ"
    elif user_data.active == UserActivity.inactive:
        return "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞"
    else:
        return ""


def get_config_data(user_config: WgConfig):
    return f"""[Interface]
PrivateKey = {user_config.user_private_key}
Address = {user_config.address}
DNS = {user_config.dns}
[Peer]
PublicKey = {settings.WG_SERVER_KEY}
AllowedIPs = {user_config.allowed_ips}
Endpoint = {user_config.endpoint_ip}:{user_config.endpoint_port}
PersistentKeepalive = 25
"""


async def create_config_file(config: str):
    path = os.path.join(PATH, "tmp", f"{uuid.uuid3(uuid.NAMESPACE_DNS, config)}.conf")

    async with aiofiles.open(path, "w") as file:
        await file.write(config)

    return path


def create_config_qr(config: str):
    path = os.path.join(PATH, "tmp", f"{uuid.uuid3(uuid.NAMESPACE_DNS, config)}.png")

    qr = pyqrcode.create(config)
    qr.png(path, scale=8)

    return path


def get_end_sub(user_data: UserData):
    try:
        end = round(user_data.fbalance / (user_data.stage * settings.cost))
    except ZeroDivisionError:
        end = 0
    else:
        if end < 0:
            end = 0

    return end


def get_rate_descr(rate: int):
    general_1 = "\n<b>‚ÄºÔ∏è (–ü–ª–∞—Ç–∞ –≤–∑–∏–º–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ!)</b>"
    general_2 = "\n\n‚ùóÔ∏è (–û–¥–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º, –æ–¥–Ω–∞–∫–æ —Ç–∞–∫–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)"

    match rate:
        case 0:
            descr = "<b>–¢–∞—Ä–∏—Ñ: –ù—É–ª–µ–≤–æ–π</b>" "\n–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –Ω–∏–∫–∞–∫–æ–π —Ç–∞—Ä–∏—Ñ" + general_2
        case 0.3:
            descr = (
                "<b>–¢–∞—Ä–∏—Ñ: –ü—Ä–æ–±–Ω—ã–π</b>\n"
                "\n‚ùóÔ∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω <b>–µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ</b>"
                "\n–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥—Ä—É–≥–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –ª–∏—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ"
                "\n\n‚ÄºÔ∏è –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ <b>7 –¥–Ω–µ–π</b>"
                "\n\n‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ VPN —Å–µ—Ä–≤–∏—Å—É"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ 1 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)" + general_2
            )
        case 1:
            descr = (
                "<b>–¢–∞—Ä–∏—Ñ: ‚≠êÔ∏è–ë–∞–∑–æ–≤—ã–π‚≠êÔ∏è</b>\n"
                "\n‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–æ–≤–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É VPN —Å–µ—Ä–≤–∏—Å–∞"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ 3 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)"
                + general_2
                + f"\n\n‚ÄºÔ∏è –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞: <b>{get_plural(settings.cost * rate, '—Ä—É–±–ª—å, —Ä—É–±–ª—è, —Ä—É–±–ª–µ–π')} –≤ –¥–µ–Ω—å</b>."
                + general_1
            )
        case 2.5:
            descr = (
                "<b>–¢–∞—Ä–∏—Ñ: üåü–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–πüåü</b>\n"
                "\n‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É VPN —Å–µ—Ä–≤–∏—Å–∞"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã VPN —Å–µ—Ä–≤–∏—Å–∞"
                "\n‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ 8 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (8 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)"
                + general_2
                + f"\n\n‚ÄºÔ∏è –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞: <b>{get_plural(settings.cost * rate, '—Ä—É–±–ª—å, —Ä—É–±–ª—è, —Ä—É–±–ª–µ–π')} –≤ –¥–µ–Ω—å</b>. "
                + general_1
            )
        case 5:
            descr = (
                "<b>–¢–∞—Ä–∏—Ñ: üí∞–õ—é–∫—Åüí∞</b>\n"
                "\n‚úÖ –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É VPN —Å–µ—Ä–≤–∏—Å–∞"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç—ã VPN —Å–µ—Ä–≤–∏—Å–∞"
                "\n‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
                "\n‚úÖ –ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–µ —Å–µ—Ä–≤–∏—Å–∞ (–ü–æ–º–æ–∂–µ—Ç –∏ —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –∫–∞–∫ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–ª–∏ –ø–æ—á–∏–Ω–∏—Ç—å)"
                "\n‚úÖ –¢–æ–ª—å–∫–æ –æ–±–ª–∞–¥–∞—Ç–µ–ª–∏ —Ç–∞—Ä–∏—Ñ–∞ –õ—é–∫—Å –º–æ–≥—É—Ç –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
                "\n‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ 15 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (15 —É—Å—Ç—Ä–æ–π—Å—Ç–≤)"
                + general_2
                + f"\n\n‚ÄºÔ∏è –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞: <b>{get_plural(settings.cost * rate, '—Ä—É–±–ª—å, —Ä—É–±–ª—è, —Ä—É–±–ª–µ–π')} –≤ –¥–µ–Ω—å</b>. "
                + general_1
            )
    return descr
